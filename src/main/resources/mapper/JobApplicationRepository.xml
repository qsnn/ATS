<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platform.ats.repository.JobApplicationRepository">

    <update id="updateDeletedApplicationToActive">
        UPDATE job_application
        SET delete_flag = 0
        WHERE user_id = #{userId}
          AND job_id = #{jobId}
          AND resume_id = #{resumeId}
          AND delete_flag = 1
    </update>

    <select id="countPendingApplicationsByCompanyId" resultType="int">
        SELECT COUNT(*)
        FROM job_application ja
        JOIN job_info ji ON ja.job_id = ji.job_id
        WHERE ji.company_id = #{companyId}
          AND ja.status = 1
          AND ja.delete_flag = 0
          AND ji.delete_flag = 0
    </select>

    <select id="selectUpcomingInterviewsByCompanyId" resultType="com.platform.ats.entity.application.JobApplication">
        SELECT ja.*
        FROM job_application ja
        JOIN job_info ji ON ja.job_id = ji.job_id
        WHERE ji.company_id = #{companyId}
          AND ja.status = 2
          AND ja.delete_flag = 0
          AND ji.delete_flag = 0
          AND EXISTS (
              SELECT 1
              FROM interview_info ii
              WHERE ii.application_id = ja.application_id
                AND ii.interview_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 2 HOUR)
                AND ii.delete_flag = 0
          )
    </select>
</mapper>